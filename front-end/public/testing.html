<!DOCTYPE html>
<html>
<head>
	<title>IR - Testing</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"></script>
</head>
<body>

    <!--  <div>
        <video id="videoPlayer" controls="true"></video>
     </div>

	<script src="http://cdn.dashjs.org/latest/dash.all.js"></script>
     <script>
        (function(){

           var url = "http://dash.edgesuite.net/akamai/test/caption_test/ElephantsDream/elephants_dream_480p_heaac5_1.mpd";

           var context = new Dash.di.DashContext();

           var player = new MediaPlayer(context);

           player.startup();

           player.attachView(document.querySelector("#videoPlayer"));

           player.attachSource(url);

        })();
     </script> -->

     <div id="video-container">
		<video id="camera-stream" width="500" controls autoplay></video>
	</div>


	<video src="outputs/username-videotitle.webm" id="testervideo" width="500" controls autoplay></video>


	<script>

		var lastone = false;

		function tellServerInterviewStarted() {
			$.ajax({
				type: 'POST',
				url: '/api/blobpiece/started',
				data: 'username-videotitle'
			});
		}

		function sendBlobToServer(blob) {
			var isLastOne = lastone;
			$.ajax({
				type: 'POST',
				url: '/api/blobpiece/video',
				data: blob.video,
				processData: false,
				contentType: false
			}).done(function(data) {
				if(isLastOne)
					tellServerWeFinished()
			});

			$.ajax({
				type: 'POST',
				url: '/api/blobpiece/audio',
				data: blob.audio,
				processData: false,
				contentType: false
			});
		}

		function tellServerWeFinished() {
			$.ajax({
				type: 'POST',
				url: '/api/blobpiece/finished',
				data: 'username-videotitle'
			}).done(function(data) {
				var vid = document.getElementById('testervideo');
				vid.src = "outputs/username-videotitle.webm";
				vid.load();
			});
		}

		window.onload = function() {

			// Normalize the various vendor prefixed versions of getUserMedia.
			navigator.getUserMedia = (navigator.getUserMedia ||
									  navigator.webkitGetUserMedia ||
									  navigator.mozGetUserMedia || 
									  navigator.msGetUserMedia);

			// Check that the browser supports getUserMedia.
			// If it doesn't show an alert, otherwise continue.
			if (navigator.getUserMedia) {
				// Request the camera.
				navigator.getUserMedia(
					// Constraints
					{
						video: true,
						audio: true
					},

					// Success Callback
					function(localMediaStream) {

						// Get a reference to the video element on the page.
						var vid = document.getElementById('camera-stream');

						// Create an object URL for the video stream and use this 
						// to set the video source.
						vid.src = window.URL.createObjectURL(localMediaStream);


						var multiStreamRecorder = new MultiStreamRecorder(localMediaStream);
						multiStreamRecorder.video = vid;
						multiStreamRecorder.audioChannels = 1;

    					multiStreamRecorder.ondataavailable = function (blobs) {
							sendBlobToServer(blobs)
					    };

					    tellServerInterviewStarted();
					    multiStreamRecorder.start(3000);

						setTimeout(function() {
							lastone = true;
							multiStreamRecorder.stop()
						}, 15*1000);
					},

					// Error Callback
					function(err) {
						// Log the error to the console.
						console.log('The following error occurred when trying to use getUserMedia: ' + err);
					}
				);

			} else {
				alert('Sorry, your browser does not support getUserMedia');
			}
		}
	</script>
</body>
</html>